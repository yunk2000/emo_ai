<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“¶å‘å®ˆæŠ¤è€… - æƒ…æ„ŸAIé™ªä¼´ç³»ç»Ÿ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- å†å²è®°å½•ä¾§è¾¹æ  -->
        <div class="history-sidebar">
            <div class="history-header">
                <h2 style="display: inline-block;margin-left: 20px;padding-top: 15px;margin-bottom: 10px;">èŠå¤©å†å²</h2>
                <!-- <button class="toggle-btn" onclick="toggleSidebar()">â—€</button> -->
            </div>
            <div class="history-groups" id="historyGroups"></div>
        </div>

        <div class="container">
            <div class="chat-card">
                <!-- å¤´éƒ¨ -->
                <div class="header">
                    <h1>é“¶å‘å®ˆæŠ¤è€…</h1>
                    <div class="status">
                        <div class="status-indicator"></div>
                        <span>åœ¨çº¿é™ªä¼´ä¸­</span>
                        <div class="user-status" id="userStatus" onclick="handleUserStatusClick()">
                            æœªç™»å½•
                        </div>
                    </div>
                </div>

                <!-- èŠå¤©åŒºåŸŸ -->
                <div class="chat-body" id="chatBody">
                    <div class="message bot-message">ä¸‹åˆå¥½ï¼ä»Šå¤©æƒ³å¬äº¬å‰§è¿˜æ˜¯èŠèŠèœè°±ï¼Ÿ</div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="input-area">
                    <div class="input-box">
                        <input type="text" id="userInput" placeholder="è¯´ç‚¹ä»€ä¹ˆæˆ–æŒ‰ä½è¯­éŸ³é”®">
                    </div>
                    <button class="btn btn-voice">ğŸ¤</button>
                    <button class="btn btn-primary" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯å¼¹çª— -->
        <div class="modal-overlay" id="userInfoModal">
            <div class="modal-content">
                <h2>ç”¨æˆ·ä¿¡æ¯</h2>
                <div id="userInfoContent" style="margin-bottom: 1.5rem;"></div>
                <button onclick="handleLogout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const inputField = document.getElementById('userInput');

            // å›è½¦å‘é€
            inputField.addEventListener('keydown', function (event) {
                if (event.key === 'Enter' || event.keyCode === 13) {
                    if (!event.shiftKey) { // å…è®¸Shift+Enteræ¢è¡Œ
                        event.preventDefault();
                        sendMessage();
                    }
                }
            });

            // è¾“å…¥æ¡†è‡ªåŠ¨å¢é«˜ï¼ˆæ”¯æŒå¤šè¡Œè¾“å…¥ï¼‰
            inputField.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        });

        function appendMessage(text, isUser, timestamp = new Date()) {
            // å‚æ•°éªŒè¯å’Œæ—¶é—´å¤„ç†
            if (!(timestamp instanceof Date)) {
                timestamp = new Date();
            }
            const chatBody = document.getElementById('chatBody');

            // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
            const message = document.createElement('div');
            message.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            message.dataset.timestamp = timestamp.toISOString();

            // åˆ›å»ºå†…å®¹å®¹å™¨
            const contentContainer = document.createElement('div');
            contentContainer.className = 'message-content';
            contentContainer.textContent = text;

            // éç”¨æˆ·æ¶ˆæ¯æ·»åŠ è¯­éŸ³åŠŸèƒ½
            if (!isUser) {
                // æ·»åŠ è¯­éŸ³å›¾æ ‡
                const voiceIcon = createVoiceIcon(text);
                message.appendChild(voiceIcon);

                // æ·»åŠ æ—¶é—´æˆ³
                const timeBadge = document.createElement('div');
                timeBadge.className = 'message-time';
                timeBadge.textContent = timestamp.toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                contentContainer.appendChild(timeBadge);
            }

            // ç»„è£…æ¶ˆæ¯ç»“æ„
            message.appendChild(contentContainer);

            // åŠ¨ç”»æ•ˆæœ
            message.style.opacity = '0';
            message.style.transform = isUser ? 'translateX(20px)' : 'translateX(-20px)';
            chatBody.appendChild(message);

            // è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                message.style.opacity = '1';
                message.style.transform = 'translateX(0)';
            }, 10);

            // è‡ªåŠ¨æ»šåŠ¨
            chatBody.scrollTop = chatBody.scrollHeight;

            return message; // è¿”å›æ¶ˆæ¯å…ƒç´ å¼•ç”¨
        }

        // åˆ›å»ºè¯­éŸ³å›¾æ ‡ç»„ä»¶
        function createVoiceIcon(text) {
            const iconContainer = document.createElement('div');
            iconContainer.className = 'voice-control';

            // è¯­éŸ³å›¾æ ‡
            const icon = document.createElement('div');
            icon.className = 'speech-icon';
            icon.dataset.text = encodeURIComponent(text);

            // ç‚¹å‡»äº‹ä»¶å¤„ç†
            icon.addEventListener('click', async function (e) {
                e.stopPropagation();
                await handleVoicePlay(this);
            });

            // åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨
            const loading = document.createElement('div');
            loading.className = 'voice-loading hidden';
            loading.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';

            iconContainer.appendChild(icon);
            iconContainer.appendChild(loading);

            return iconContainer;
        }

        // åœ¨å…¨å±€ä½œç”¨åŸŸæ·»åŠ éŸ³é¢‘æ§åˆ¶å˜é‡
        let currentAudio = null; // å½“å‰æ’­æ”¾çš„éŸ³é¢‘å®ä¾‹
        let currentPlayingIcon = null; // å½“å‰æ’­æ”¾çš„å›¾æ ‡

        // ä¿®æ”¹è¯­éŸ³æ’­æ”¾å¤„ç†å‡½æ•°
        async function handleVoicePlay(icon) {
            try {
                // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ­£åœ¨æ’­æ”¾çš„å›¾æ ‡
                if (icon === currentPlayingIcon) {
                    currentAudio.pause();
                    currentAudio = null;
                    icon.classList.remove('playing');
                    currentPlayingIcon = null;
                    return;
                }

                // åœæ­¢æ‰€æœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘
                stopAllAudio();

                // æ›´æ–°æ’­æ”¾çŠ¶æ€
                currentPlayingIcon = icon;
                icon.classList.add('playing');

                // è·å–éœ€è¦åˆæˆçš„æ–‡æœ¬
                const text = decodeURIComponent(icon.dataset.text);

                // ç”Ÿæˆè¯­éŸ³ï¼ˆå¸¦ç¼“å­˜ï¼‰
                const audioUrl = await getCachedSpeech(text);

                // åˆ›å»ºæ–°çš„éŸ³é¢‘å®ä¾‹
                const audio = new Audio(audioUrl);
                currentAudio = audio;

                // éŸ³é¢‘æ’­æ”¾ç»“æŸå¤„ç†
                audio.addEventListener('ended', () => {
                    icon.classList.remove('playing');
                    currentAudio = null;
                    currentPlayingIcon = null;
                });

                // éŸ³é¢‘æ’­æ”¾é”™è¯¯å¤„ç†
                audio.addEventListener('error', () => {
                    icon.classList.remove('playing');
                    currentAudio = null;
                    currentPlayingIcon = null;
                });

                // å¼€å§‹æ’­æ”¾
                await audio.play();
            } catch (error) {
                console.error('è¯­éŸ³æ’­æ”¾å¤±è´¥:', error);
                icon.classList.remove('playing');
                currentAudio = null;
                currentPlayingIcon = null;
                appendMessage(`è¯­éŸ³æ’­æ”¾å¤±è´¥: ${error.message}`, false);
            }
        }

        // æ–°å¢åœæ­¢æ‰€æœ‰éŸ³é¢‘çš„å‡½æ•°
        function stopAllAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0; // é‡ç½®æ’­æ”¾è¿›åº¦
                currentAudio = null;
            }
            if (currentPlayingIcon) {
                currentPlayingIcon.classList.remove('playing');
                currentPlayingIcon = null;
            }
        }

        // å¸¦ç¼“å­˜çš„è¯­éŸ³åˆæˆå‡½æ•°
        const speechCache = new Map();

        async function getCachedSpeech(text) {
            // æ£€æŸ¥ç¼“å­˜
            if (speechCache.has(text)) {
                return speechCache.get(text);
            }

            // è°ƒç”¨åç«¯åˆæˆè¯­éŸ³
            const response = await fetch('http://localhost:5000/api/synthesize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    speed: 4,
                    pitch: 5,
                    volume: 5,
                    person: 4
                })
            });

            if (!response.ok) {
                throw new Error('è¯­éŸ³ç”Ÿæˆå¤±è´¥');
            }

            // ç”ŸæˆBlob URLå¹¶ç¼“å­˜
            const blob = await response.blob();
            const audioUrl = URL.createObjectURL(blob);
            speechCache.set(text, audioUrl);

            return audioUrl;
        }

        // ç”¨æˆ·ç³»ç»Ÿ
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;

        function initUserStatus() {
            const userStatus = document.getElementById('userStatus');
            userStatus.textContent = currentUser ? currentUser.username : 'æœªç™»å½•';

            const chatBody = document.getElementById('chatBody');
            chatBody.innerHTML = '';

            if (currentUser) {
                loadChatHistory();
            } else {
                appendMessage(getGreetingByTime() + 'è¯·ç™»å½•åä½¿ç”¨å®Œæ•´åŠŸèƒ½', false);
            }
        }

        async function loadChatHistory() {
            if (!currentUser) return;

            const today = new Date().toISOString().split('T')[0];
            const apiUrl = `http://localhost:2025/chat/selectChatInfoByTime?username=${encodeURIComponent(currentUser.username)}&timestamp=${today}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
                const data = await response.json();

                const chatBody = document.getElementById('chatBody');
                chatBody.innerHTML = '';

                if (data.length === 0) {
                    appendMessage(getGreetingByTime() + 'ä»Šå¤©æƒ³å¬äº¬å‰§è¿˜æ˜¯èŠèŠèœè°±ï¼Ÿ', false);
                    return;
                }

                data.forEach(chat => {
                    const userTime = new Date(`${chat.timestamp}T${chat.hss}`);
                    const aiTime = new Date(userTime.getTime() + parseInt(chat.useTime));

                    appendMessage(chat.content, true, userTime);
                    appendMessage(chat.contentAi, false, aiTime);
                });
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                appendMessage('å†å²è®°å½•åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', false);
            }
        }

        // é¢„åŠ è½½è¯­éŸ³ï¼ˆåå°é™é»˜åŠ è½½ï¼‰
        function preloadSpeech(text) {
            getCachedSpeech(text).catch(() => {
                console.log('è¯­éŸ³é¢„åŠ è½½å¤±è´¥:', text);
            });
        }

        function getGreetingByTime() {
            const hour = new Date().getHours();
            if (hour < 6) return 'å‡Œæ™¨å¥½ï¼';
            if (hour < 9) return 'æ—©ä¸Šå¥½ï¼';
            if (hour < 12) return 'ä¸Šåˆå¥½ï¼';
            if (hour < 14) return 'ä¸­åˆå¥½ï¼';
            if (hour < 18) return 'ä¸‹åˆå¥½ï¼';
            return 'æ™šä¸Šå¥½ï¼';
        }

        function handleUserStatusClick() {
            if (!currentUser) {
                window.location.href = 'login.html';
            } else {
                showUserInfo();
            }
        }

        function showUserInfo() {
            const modal = document.getElementById('userInfoModal');
            const content = document.getElementById('userInfoContent');
            content.innerHTML = `
                <p>ç”¨æˆ·åï¼š${currentUser.username}</p>
                <p>è”ç³»ç”µè¯ï¼š${currentUser.phone}</p>
            `;
            modal.style.display = 'flex';
            modal.onclick = function (event) {
                if (event.target === modal) closeModal();
            }
        }

        function handleLogout() {
            stopAllAudio(); // é€€å‡ºç™»å½•æ—¶åœæ­¢æ’­æ”¾
            localStorage.removeItem('currentUser');
            currentUser = null;
            initUserStatus();
            closeModal();
        }

        function closeModal() {
            stopAllAudio(); // å…³é—­å¼¹çª—æ—¶åœæ­¢æ’­æ”¾
            document.getElementById('userInfoModal').style.display = 'none';
        }

        // ================== æ”¹è¿›çš„è¯­éŸ³åŠŸèƒ½ ==================
        let mediaRecorder = null;
        let audioChunks = [];
        const MAX_RECORD_TIME = 60;

        // äº‹ä»¶ç›‘å¬å™¨ç»‘å®šï¼ˆæ–°å¢ï¼‰
        document.querySelector('.btn-voice').addEventListener('click', toggleRecording);

        async function toggleRecording() {
            const voiceBtn = document.querySelector('.btn-voice');

            try {
                if (!mediaRecorder) {
                    // å¼€å§‹å½•éŸ³
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1
                        }
                    });

                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus',
                        audioBitsPerSecond: 16000
                    });

                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = async () => {
                        const webmBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        await handleAudioUpload(webmBlob);
                        audioChunks = [];
                    };

                    mediaRecorder.start();
                    voiceBtn.classList.add('recording');
                    voiceBtn.title = 'ç‚¹å‡»ç»“æŸå½•éŸ³';

                    setTimeout(() => {
                        if (mediaRecorder?.state === 'recording') stopRecording();
                    }, MAX_RECORD_TIME * 1000);

                } else {
                    // åœæ­¢å½•éŸ³
                    stopRecording();
                }
            } catch (err) {
                console.error('å½•éŸ³å¤±è´¥:', err);
                alert(`éº¦å…‹é£è®¿é—®å¤±è´¥: ${err.message}`);
            }
        }

        function stopRecording() {
            if (mediaRecorder?.state === 'recording') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                mediaRecorder = null;
                document.querySelector('.btn-voice').classList.remove('recording');
            }
        }

        // æ”¹è¿›çš„éŸ³é¢‘å¤„ç†ï¼ˆæ–°å¢ç™»å½•æ ¡éªŒï¼‰
        async function handleAudioUpload(blob) {
            const inputField = document.getElementById('userInput');

            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•åå†ä½¿ç”¨è¯­éŸ³åŠŸèƒ½ï¼');
                window.location.href = 'login.html';
                return;
            }

            try {
                inputField.disabled = true;
                inputField.placeholder = 'è¯†åˆ«ä¸­....';

                const formData = new FormData();
                formData.append('audio', blob, 'recording.webm');

                const response = await fetch('http://localhost:5000/api/speech', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'  // æ˜ç¡®å‘ŠçŸ¥æœŸæœ›JSONå“åº”
                    },
                    mode: 'cors'
                });

                const result = await response.json();
                // console.log(response)
                // console.log(result)

                if (result.status === 'success') {
                    inputField.value = result.text;
                    console.log('æ–‡ä»¶ä¿å­˜è·¯å¾„:', result.file_path);
                } else {
                    throw new Error(result.msg || 'è¯†åˆ«å¤±è´¥');
                }
            } catch (err) {
                console.error('è¯†åˆ«é”™è¯¯:', err);
                inputField.placeholder = `é”™è¯¯: ${err.message}`;
                setTimeout(() => {
                    inputField.placeholder = 'è¯´ç‚¹ä»€ä¹ˆæˆ–æŒ‰ä½è¯­éŸ³é”®';
                }, 3000);
            } finally {
                inputField.disabled = false;
            }
        }

        // ================== æ”¹è¿›çš„æ¶ˆæ¯å‘é€ ==================
        async function sendMessage() {
            stopAllAudio(); // å‘é€æ–°æ¶ˆæ¯æ—¶åœæ­¢å½“å‰æ’­æ”¾
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•åå†å‘é€æ¶ˆæ¯ï¼');
                window.location.href = 'login.html';
                return;
            }

            const input = document.getElementById('userInput');
            const msg = input.value.trim();

            if (!msg) {
                input.placeholder = 'è¾“å…¥ä¸èƒ½ä¸ºç©ºï¼';
                setTimeout(() => input.placeholder = 'è¯´ç‚¹ä»€ä¹ˆæˆ–æŒ‰ä½è¯­éŸ³é”®', 2000);
                return;
            }

            appendMessage(msg, true);
            input.value = '';

            try {
                // ç”Ÿæˆæ—¶é—´æˆ³
                const now = new Date();
                const timestamp = now.toISOString().split('T')[0];
                const hss = now.toTimeString().split(' ')[0].substring(0, 8);

                // åˆ›å»ºè¯·æ±‚å¯¹è±¡
                const requestData = {
                    username: currentUser.username,
                    content: msg,
                    timestamp: timestamp,
                    hss: hss
                };

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingMsg = createThinkingMessage(); // ä¿®æ”¹åçš„åŠ è½½æ•ˆæœ

                // å‘é€è¯·æ±‚
                const response = await fetch('http://localhost:2025/chat/chatRecordInsert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                // ç»Ÿä¸€è¯»å–å“åº”æ•°æ®
                const responseData = await response.json(); // å…³é”®ä¿®æ”¹ï¼šåªè¯»å–ä¸€æ¬¡

                // ç§»é™¤åŠ è½½çŠ¶æ€
                document.getElementById('chatBody').removeChild(loadingMsg);

                if (!response.ok) {
                    throw new Error(responseData.message || `è¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                // æ­£ç¡®è·å–resultå­—æ®µ
                const aiResponse = responseData.result || 'æ”¶åˆ°æ‚¨çš„è¯·æ±‚';
                await typewriterEffect(aiResponse, 50);

                // æ–°å¢è¯­éŸ³åˆæˆè°ƒç”¨
                await synthesizeAndPlaySpeech(aiResponse);

            } catch (error) {
                console.error('æ¶ˆæ¯å‘é€å¤±è´¥:', error);

                // ç¡®ä¿ç§»é™¤åŠ è½½çŠ¶æ€
                if (loadingMsg && loadingMsg.parentNode) {
                    document.getElementById('chatBody').removeChild(loadingMsg);
                }

                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                appendMessage(`å‘é€å¤±è´¥: ${error.message}`, false);

                // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ç‰¹æ®Šå¤„ç†
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    appendMessage('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', false);
                }
            }
        }

        // è¯­éŸ³åˆæˆå‡½æ•°
        async function synthesizeAndPlaySpeech(text) {
            let voiceLoading = null;

            try {
                // æ˜¾ç¤ºè¯­éŸ³åŠ è½½çŠ¶æ€
                voiceLoading = appendMessage('è¯­éŸ³ç”Ÿæˆä¸­...', false);

                // è°ƒç”¨Pythonè¯­éŸ³åˆæˆAPI
                const response = await fetch('http://localhost:5000/api/synthesize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        speed: 4,
                        pitch: 5,
                        volume: 5,
                        person: 4
                    })
                });

                // å®‰å…¨ç§»é™¤åŠ è½½çŠ¶æ€
                if (voiceLoading?.parentNode) {
                    voiceLoading.parentNode.removeChild(voiceLoading);
                }

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯ ${response.status}`);
                }

                // åˆ›å»ºéŸ³é¢‘æ’­æ”¾å™¨
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audioPlayer = new Audio(audioUrl);

                // åˆ›å»ºæ’­æ”¾å™¨å®¹å™¨
                const playerContainer = document.createElement('div');
                playerContainer.className = 'audio-message';
                playerContainer.innerHTML = `
            <audio src="${audioUrl}" controls></audio>
        `;

                // æ·»åŠ æ’­æ”¾å™¨åˆ°èŠå¤©æ¡†
                appendMessageNode(playerContainer, false);

            } catch (error) {
                console.error('è¯­éŸ³ç”Ÿæˆå¤±è´¥:', error);

                // å®‰å…¨ç§»é™¤åŠ è½½çŠ¶æ€
                if (voiceLoading?.parentNode) {
                    voiceLoading.parentNode.removeChild(voiceLoading);
                }

                appendMessage(`è¯­éŸ³ç”Ÿæˆå¤±è´¥: ${error.message}`, false);
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ åŒ…å«DOMèŠ‚ç‚¹çš„æ¶ˆæ¯
        function appendMessageNode(node, isUser) {
            const container = document.createElement('div');
            container.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            container.appendChild(node);
            document.getElementById('chatBody').appendChild(container);
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function createThinkingMessage() {
            const container = document.createElement('div');
            container.className = 'message bot-message typing-indicator';

            const text = document.createElement('span');
            text.textContent = 'æ€è€ƒä¸­';

            // æ·»åŠ åŠ¨æ€ç‚¹
            [1, 2, 3, 4, 5, 6].forEach(() => {
                const dot = document.createElement('span');
                dot.className = 'typing-dot';
                dot.textContent = '.';
                container.appendChild(dot);
            });

            document.getElementById('chatBody').appendChild(container);
            return container;
        }

        function typewriterEffect(text, speed = 50) {
            return new Promise((resolve) => {
                const container = document.createElement('div');
                container.className = 'message bot-message';
                document.getElementById('chatBody').appendChild(container);

                let index = 0;
                const timer = setInterval(() => {
                    if (index < text.length) {
                        container.textContent = text.substring(0, index + 1);
                        index++;
                        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                        container.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        clearInterval(timer);
                        resolve();
                    }
                }, speed);
            });
        }

        // æ—¥æœŸæ ¼å¼åŒ–å·¥å…·å‡½æ•°
        function formatDate(date) {
            return date.toISOString().split('T')[0]; // yyyy-MM-dd
        }

        function formatTime(date) {
            return date.toTimeString().split(' ')[0].substring(0, 8); // HH:mm:ss
        }

        // åˆ›å»ºåŠ è½½çŠ¶æ€æ¶ˆæ¯
        function createLoadingMessage() {
            const botMsg = document.createElement('div');
            botMsg.className = 'message bot-message';
            botMsg.innerHTML = `
        <div class="loading-dots">
            <span>.</span><span>.</span><span>.</span>
        </div>
    `;
            document.getElementById('chatBody').appendChild(botMsg);
            return botMsg;
        }



        function generateDateItems() {
            const today = new Date();
            const dates = {
                today: [],
                lastWeek: []
            };

            // ç”Ÿæˆä»Šæ—¥æ•°æ®
            dates.today.push(today.toISOString().split('T')[0]);

            // ç”Ÿæˆè¿‡å»6å¤©æ•°æ®ï¼ˆå…±7å¤©ï¼‰
            for (let i = 1; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dates.lastWeek.push(date.toISOString().split('T')[0]);
            }

            return dates;
        }

        // åˆå§‹åŒ–å†å²è®°å½•ä¾§è¾¹æ 
        async function initHistorySidebar() {
            const groupsContainer = document.getElementById('historyGroups');
            groupsContainer.innerHTML = '';

            const dateData = generateDateItems();
            const groups = [
                { title: 'ä»Šæ—¥èŠå¤©', key: 'today', items: dateData.today },
                { title: 'ä¸€å‘¨å†…è®°å½•', key: 'week', items: dateData.lastWeek }
            ];

            groups.forEach(group => {
                const groupElement = document.createElement('div');
                groupElement.className = 'history-group';
                groupElement.innerHTML = `
            <div class="group-header" onclick="toggleGroup(this)">
                <span class="group-title">${group.title}</span>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="group-content">
                ${group.items.map(date => `
                    <div class="date-item" 
                         data-date="${date}"
                         onclick="loadDateHistory('${date}')">
                        ${formatDisplayDate(date)}
                    </div>
                `).join('')}
            </div>
        `;
                groupsContainer.appendChild(groupElement);
            });
        }

        // å¢å¼ºçš„æ—¥æœŸåŠ è½½å‡½æ•°
        async function loadDateHistory(date) {
            try {
                // æ¸…é™¤é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.date-item').forEach(item => {
                    item.classList.remove('active');
                });

                // è®¾ç½®å½“å‰é€‰ä¸­çŠ¶æ€
                event.target.closest('.date-item').classList.add('active');

                // è°ƒç”¨åç«¯æ¥å£
                const response = await fetch(
                    `http://localhost:2025/chat/selectChatInfoByTime?username=${encodeURIComponent(currentUser.username)
                    }&timestamp=${encodeURIComponent(date)
                    }`
                );

                if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);

                const data = await response.json();
                const chatBody = document.getElementById('chatBody');
                chatBody.innerHTML = ''; // æ¸…ç©ºèŠå¤©åŒºåŸŸ
                // console.log(data)

                // å¤„ç†ç©ºæ•°æ®æƒ…å†µ
                if (!data || data.length === 0) {
                    appendMessage(`${formatDisplayDate(date)}æ²¡æœ‰èŠå¤©è®°å½•`, false);
                    return;
                }

                // æ¸²æŸ“æ¶ˆæ¯
                data.forEach(chat => {
                    const userTime = new Date(`${chat.timestamp}T${chat.hss}`);
                    const aiTime = new Date(userTime.getTime() + parseInt(chat.useTime));
                    appendMessage(chat.content, true, userTime);
                    appendMessage(chat.contentAi, false, aiTime);
                });

            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                appendMessage(`åŠ è½½å¤±è´¥: ${error.message}`, false);
            }
        }

        // æ—¥æœŸæ ¼å¼åŒ–æ˜¾ç¤º
        function formatDisplayDate(dateStr) {
            const date = new Date(dateStr);

            // ç¡®ä¿æ—¥æœŸæœ‰æ•ˆæ€§
            if (isNaN(date)) {
                console.error('æ— æ•ˆæ—¥æœŸ:', dateStr);
                return 'æ—¥æœŸæ— æ•ˆ';
            }

            // ä¸­æ–‡æ ¼å¼é€‰é¡¹
            const options = {
                month: 'long',
                day: 'numeric',
                weekday: 'short'
            };

            try {
                // ç”Ÿæˆä¸­æ–‡æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆç¤ºä¾‹ï¼š"3æœˆ14æ—¥ å‘¨äº”"ï¼‰
                const datePart = date.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' });
                const weekPart = date.toLocaleDateString('zh-CN', { weekday: 'short' });
                return `${datePart} ${weekPart}`;
            } catch (error) {
                console.error('æ—¥æœŸæ ¼å¼åŒ–å¤±è´¥:', error);
                return dateStr; // è¿”å›åŸå§‹æ—¥æœŸä½œä¸ºfallback
            }
        }

        // åˆ†ç»„æŠ˜å /å±•å¼€
        function toggleGroup(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');

            content.classList.toggle('expanded');
            icon.style.transform = content.classList.contains('expanded')
                ? 'rotate(180deg)'
                : 'none';
        }

        // åŠ è½½æŒ‡å®šæ—¥æœŸçš„å†å²è®°å½•
        async function loadDateHistory(date) {
            try {
                // ç§»é™¤åŸæœ‰é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.date-item').forEach(item => {
                    item.classList.remove('active');
                });

                // è®¾ç½®å½“å‰é€‰ä¸­çŠ¶æ€
                event.target.closest('.date-item').classList.add('active');

                // è°ƒç”¨æ¥å£è·å–æ•°æ®
                const response = await fetch(`http://localhost:2025/chat/selectChatInfoByTime?username=${currentUser.username}&timestamp=${date}`);
                const data = await response.json();

                // æ¸…ç©ºèŠå¤©åŒºåŸŸ
                const chatBody = document.getElementById('chatBody');
                chatBody.innerHTML = '';

                // æ¸²æŸ“å†å²è®°å½•
                data.forEach(chat => {
                    appendMessage(chat.content, true, new Date(`${chat.timestamp}T${chat.hss}`));
                    appendMessage(chat.contentAi, false, new Date(`${chat.timestamp}T${chat.hss}`));
                });

            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                appendMessage('å†å²è®°å½•åŠ è½½å¤±è´¥', false);
            }
        }

        // ä¾§è¾¹æ æŠ˜å /å±•å¼€
        function toggleSidebar() {
            document.querySelector('.app-container').classList.toggle('collapsed');
            document.querySelector('.toggle-btn').textContent =
                document.querySelector('.app-container').classList.contains('collapsed') ? 'â–¶' : 'â—€';
        }

        // åˆå§‹åŒ–æ—¶åŠ è½½ä¾§è¾¹æ 
        document.addEventListener('DOMContentLoaded', () => {
            initHistorySidebar();
        });

        // åˆå§‹åŒ–
        initUserStatus();
    </script>

    <style>
        /* è®¾è®¡ç³»ç»Ÿå˜é‡ */
        :root {
            --primary: #5B8FF9;
            /* ç§‘æŠ€è“ */
            --secondary: #FF9A3E;
            /* æ¸©æš–æ©™ */
            --success: #7ED321;
            /* å®‰å…¨ç»¿ */
            --danger: #FF4D4F;
            /* è­¦ç¤ºçº¢ */
            --bg: #F8F9FE;
            /* èƒŒæ™¯è‰² */
            --text: #2C3E50;
            /* ä¸»æ–‡æœ¬ */
            --text-light: #7F8C8D;
            /* è¾…åŠ©æ–‡æœ¬ */
            --radius: 1rem;
            /* åœ†è§’ç³»ç»Ÿ */
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
            /* æŸ”å’Œé˜´å½± */
        }

        /* æ–°å¢è’™å±‚ç‚¹å‡»æ ·å¼ */
        .modal-overlay {
            cursor: pointer;
            /* æ˜¾ç¤ºå¯ç‚¹å‡»çŠ¶æ€ */
            background: rgba(0, 0, 0, 0.5);
            /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
        }

        /* å†…å®¹åŒºåŸŸé˜»æ­¢ç‚¹å‡»ç©¿é€ */
        .modal-content {
            cursor: auto;
            /* æ¢å¤é»˜è®¤å…‰æ ‡ */
            pointer-events: auto;
            /* å…è®¸å†…å®¹åŒºåŸŸäº¤äº’ */
        }

        /* åŸºç¡€é‡ç½® */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* å®¹å™¨è‡ªé€‚åº” */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            width: 100%;
            flex-grow: 1;
        }

        /* èŠå¤©å¡ç‰‡ */
        .chat-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 80vh;
            min-height: 600px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* å¤´éƒ¨è®¾è®¡ */
        .header {
            background: linear-gradient(135deg, var(--primary), #4D7CFE);
            padding: 1.5rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9em;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        /* èŠå¤©ä¸»ä½“ */
        .chat-body {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        /* æ¶ˆæ¯æ°”æ³¡ */
        .message {
            max-width: 75%;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            line-height: 1.6;
            position: relative;
            transition: transform 0.3s ease;
        }

        .message:hover {
            transform: translateY(-2px);
        }

        .message::after {
            content: attr(data-time);
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }

        @media (min-width: 768px) {
            .message::after {
                display: inline;
                margin-left: 1rem;
            }
        }

        .user-message {
            background: var(--primary);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.5rem;
        }

        .bot-message {
            background: #F0F4FF;
            color: var(--text);
            border-bottom-left-radius: 0.5rem;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            border-top: 2px solid #eee;
            padding: 1.5rem;
            display: flex;
            gap: 1rem;
            background: white;
        }

        .input-box {
            flex: 1;
            position: relative;
        }

        input {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid #E8EAF1;
            border-radius: 2rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(91, 143, 249, 0.2);
        }

        /* åŠŸèƒ½æŒ‰é’® */
        .btn {
            padding: 1rem 1.8rem;
            border: none;
            border-radius: 2rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #4D7CFE;
            transform: translateY(-1px);
        }

        .btn-voice {
            background: var(--secondary);
            color: white;
            padding: 1rem;
            min-width: 48px;
        }

        /* ç´§æ€¥æŒ‰é’® */
        .emergency-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--danger);
            color: white;
            padding: 1.2rem;
            border-radius: 50%;
            box-shadow: 0 8px 20px rgba(255, 77, 79, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .emergency-btn:hover {
            transform: scale(1.1);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                margin: 0;
                padding: 0;
                height: 100vh;
            }

            .chat-card {
                border-radius: 0;
                height: 100vh;
                min-height: auto;
            }

            .input-area {
                flex-direction: column;
                gap: 1rem;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* åŠ¨ç”» */
        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        /* æ–°å¢æ ·å¼ */
        .user-status {
            position: relative;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .user-status:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            width: 400px;
            max-width: 90%;
            box-shadow: var(--shadow);
        }

        .auth-modal {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* è¯­éŸ³å½•åˆ¶çŠ¶æ€åé¦ˆ */
        .recording {
            background-color: #ff4444 !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        /* è¾“å…¥æ¡†åŠ è½½çŠ¶æ€ */
        input:disabled {
            background: #f8f9fa;
        }

        .loading::placeholder {
            color: #4CAF50;
            animation: blink 1s infinite;
        }

        .input-box input {
            min-height: 40px;
            /* åŸºç¡€é«˜åº¦ */
            max-height: 120px;
            /* æœ€å¤§é«˜åº¦ */
            resize: none;
            /* ç¦æ­¢æ‰‹åŠ¨è°ƒæ•´ */
            overflow-y: auto;
            /* è‡ªåŠ¨æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            line-height: 1.5;
            /* è¡Œé«˜ */
            transition: height 0.2s;
            /* é«˜åº¦å˜åŒ–åŠ¨ç”» */
        }

        @keyframes blink {
            0% {
                opacity: 0.2;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.2;
            }
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
        }

        .typing-dot {
            animation: blink 1.4s infinite;
            margin-left: 2px;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .btn-primary {
            transition: all 0.3s;
        }

        .btn-primary:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-primary.responding {
            position: relative;
            padding-right: 35px;
        }

        .btn-primary.responding::after {
            content: "";
            position: absolute;
            right: 10px;
            top: 50%;
            width: 16px;
            height: 16px;
            margin-top: -8px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* æ¶ˆæ¯åŸºç¡€æ ·å¼ */
        /* .message {
            position: relative;
            max-width: 80%;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 15px;
            transition: all 0.3s ease;
        } */

        /* AI æ¶ˆæ¯ç‰¹æ®Šæ ·å¼ */
        /* .bot-message {
            background: #f1f3f4;
            align-self: flex-start;
            margin-left: 40px;
            
        } */

        /* è¯­éŸ³æ§åˆ¶åŒºåŸŸ */
        .voice-control {
            position: absolute;
            left: -35px;
            bottom: 5px;
            width: 30px;
            height: 30px;
        }

        /* è¯­éŸ³å›¾æ ‡æ ·å¼ */
        .speech-icon {
            /* width: 100%;
            height: 100%; */
            position: absolute;
            left: 58px;
            bottom: 2px;
            width: 24px;
            height: 24px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>');
            background-size: contain;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .speech-icon:hover {
            opacity: 1;
        }

        .speech-icon.playing {
            filter: brightness(0.8) sepia(1) hue-rotate(190deg) saturate(5);
        }

        /* æ—¶é—´æˆ³æ ·å¼ */
        .message-time {
            font-size: 0.75rem;
            color: #666;
            margin-top: 4px;
            text-align: right;
        }

        /* åŠ è½½çŠ¶æ€ */
        .voice-loading {
            position: absolute;
            top: -25px;
            left: 0;
            width: 100%;
        }

        .loading-dots span {
            animation: blink 1.4s infinite;
            opacity: 0.2;
        }

        /* ä¸‹é¢æ˜¯å†å²è®°å½•æ çš„ */
        /* æ•´ä½“å¸ƒå±€ */
        .app-container {
            display: flex;
            height: 100vh;
            transition: all 0.3s;
        }

        /* å†å²è®°å½•ä¾§è¾¹æ æ ·å¼ */
        .history-sidebar {
            width: 280px;
            background: white;
            /* ä¸èŠå¤©å¡ç‰‡èƒŒæ™¯ä¸€è‡´ */
            border-right: 1px solid #E8EAF1;
            /* ä¸è¾“å…¥æ¡†è¾¹æ¡†ä¸€è‡´ */
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.03);
            /* æ·»åŠ å³ä¾§é˜´å½± */
            transition: transform 0.3s;
        }

        /* åˆ†ç»„æ ‡é¢˜æ ·å¼ */
        .group-header {
            padding: 12px;
            background: #F0F4FF;
            /* ä¸AIæ¶ˆæ¯èƒŒæ™¯ä¸€è‡´ */
            border-radius: 8px;
            /* ç»Ÿä¸€åœ†è§’ */
            margin: 8px 0;
            color: var(--primary);
            /* ä¸»è‰²è°ƒæ–‡å­— */
            transition: all 0.3s;
        }

        .toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 4px;
        }

        /* å†å²è®°å½•åˆ†ç»„æ ·å¼ */
        .history-group {
            margin: 8px;
        }

        .group-header {
            padding: 12px;
            background: #ebedf0;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-header:hover {
            background: #e6ebff;
            /* ä¸»è‰²è°ƒæµ…è‰² */
            transform: translateX(4px);
        }

        .group-title {
            font-weight: 500;
        }

        .toggle-icon {
            transition: transform 0.3s;
        }

        .group-content {
            padding-left: 12px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .group-content.expanded {
            max-height: 500px;
            /* æ ¹æ®å®é™…å†…å®¹è°ƒæ•´ */
        }

        /* æ—¥æœŸé¡¹æ ·å¼ */
        .date-item {
            padding: 10px 16px;
            margin: 4px 0;
            border-radius: 6px;
            background: white;
            border: 1px solid #F0F4FF;
            /* æŸ”å’Œè¾¹æ¡† */
            transition: all 0.2s;
        }

        .date-item:hover {
            background: #F8FAFF;
            /* æ‚¬åœèƒŒæ™¯ */
            box-shadow: 0 2px 6px rgba(91, 143, 249, 0.1);
        }

        .date-item.active {
            background: var(--primary);
            /* ä¸»è‰²è°ƒå¡«å…… */
            color: white;
            border-color: var(--primary);
        }

        .date-item.active .msg-count {
            color: rgba(255, 255, 255, 0.8);
        }

        /* æŠ˜å çŠ¶æ€ */
        .collapsed .history-sidebar {
            transform: translateX(-100%);
        }

        /* æ¶ˆæ¯è®¡æ•°æ ·å¼ */
        .msg-count {
            font-size: 0.85em;
            color: var(--text-light);
            background: rgba(91, 143, 249, 0.08);
            padding: 2px 8px;
            border-radius: 12px;
        }

        /* æŠ˜å æŒ‰é’®æ ·å¼ */
        .toggle-btn {
            color: var(--primary);
            transition: all 0.3s;
        }

        .toggle-btn:hover {
            color: #4D7CFE;
            /* ä¸»è‰²è°ƒæ·±è‰² */
        }

        /* æ–°å¢æ¶ˆæ¯è®¡æ•°æ ·å¼ */
        .msg-count {
            font-size: 0.8em;
            color: #666;
            margin-left: 8px;
        }

        /* è°ƒæ•´æ—¥æœŸé¡¹é—´è· */
        .date-item {
            padding: 10px 15px;
            margin: 4px 0;
        }

        /* ä¼˜åŒ–ä¸­æ–‡æ—¥æœŸæ˜¾ç¤º */
        .group-title {
            font-size: 14px;
        }

        .message.empty-message {
            color: #666;
            font-style: italic;
            background: #f8f9fa;
            border: 1px dashed #dee2e6;
        }
    </style>
</body>

</html>